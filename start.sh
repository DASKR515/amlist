#!/usr/bin/env bash
# ูุณุฎ ูู ูููุงุช ุงููุดุฑูุน ุฅูู ุตูุฑุฉ OBB ูุงุญุฏุฉ (ูุชู ุงูุชุดุงููุง ุชููุงุฆููุง)
# ูุนูู ูู Termux / ุฃู ุจูุฆุฉ Bash ูุน mtools ููุซุจููุชุฉ.

set -euo pipefail

SCRIPT=$(basename "$0")              # start.sh ุฃู ุฃู ุงุณู ุชุนุทูู ููุณูุฑุจุช
SRC_ROOT="${1:-$(pwd)}"              # ุงููุฌูุฏ ุงูุฐู ูุญุชูู ุงููููุงุช
OBB_IMAGE="${2:-}"                   # ูุณุงุฑ OBB (ุงุฎุชูุงุฑู ููุณูุท ุซุงูู)

# === 1) ุงูุชุดุงู ููู .obb ุฅู ูู ูููุฑููุฑ ููุณูุท ===
if [[ -z "$OBB_IMAGE" ]]; then
    OBB_IMAGE=$(find "$SRC_ROOT" -maxdepth 1 -type f -iname "*.obb" | head -n 1)
fi
if [[ -z "$OBB_IMAGE" ]]; then
    echo "โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃู ููู โ.obbโ ูู $SRC_ROOT" >&2
    exit 1
fi
echo "๐ฆ ุงุณุชุฎุฏุงู ุงูุตูุฑุฉ: $OBB_IMAGE"

# === 2) ุงูุฏูุฑุงู ุนูู ูู ุงููููุงุช ููุณุฎูุง ===
find "$SRC_ROOT" -type f \
     ! -name "$(basename "$OBB_IMAGE")" \
     ! -name "$SCRIPT" |
while read -r src; do
    rel_path="${src#$SRC_ROOT/}"           # ุงููุณุงุฑ ุงููุณุจู (a/aa/a.png ...)
    dst="::/$rel_path"                     # ุงููุฌูุฉ ุฏุงุฎู ุงูู OBB
    dst_dir="::/$(dirname "$rel_path")"    # ุงููุฌูุฏ ุฏุงุฎู ุงูู OBB

    # 2-ุฃ) ุฃูุดุฆ ุงููุฌูุฏุงุช ุฏุงุฎู ุงูุตูุฑุฉ (-s = ุฃูุดุฆ ูู ุงูุชูุฑุนุงุช ุงููุงุฒูุฉ)
    mmd -i "$OBB_IMAGE" -s "$dst_dir" 2>/dev/null || true

    # 2-ุจ) ุงูุณุฎ ุงูููู (-o = ุงูุชุจ ููู ุงูููุฌูุฏ ุฅู ููุฌุฏ)
    echo "โก๏ธ โ$rel_pathโ โ โ$dst"
    mcopy -o -i "$OBB_IMAGE" "$src" "$dst"
done

echo "โ ุชู ุงุณุชุจุฏุงู ุฌููุน ุงููููุงุช ุฏุงุฎู โ$(basename "$OBB_IMAGE")โ"
